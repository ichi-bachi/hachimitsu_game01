<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ばちまるはハチミツが食べたいのじゃ！</title>
  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden;
      background: #fff7ea;
      user-select: none;
      -webkit-user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    #gameCanvas {
      background: #B8E2F9;
      touch-action: none;
      display: block;
      margin-top: 10px;
      border: 2px solid #333;
    }
    button {
      margin-top: 8px;
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #f9a825;
      color: #fff;
      box-shadow: 0 4px #b28700;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #fbc02d;
    }
    #startScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 247, 234, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      font-family: sans-serif;
      padding: 20px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>ばちまるはハチミツが食べたいのじゃ！</h1>
    <p>矢印キー または WASDで移動<br>
       左クリックでイチゴ弾を発射！<br>
       ハチの巣を壊してハチミツを集めよう！<br>
       5回ミスでゲームオーバー！<br><br>
       時間が経つとハチの巣の落下スピードが上がるのじゃ！</p>
    <button id="startBtn">GAME START</button>
  </div>

  <canvas id="gameCanvas" width="420" height="720"></canvas>
  <button id="retryBtn">RETRY</button>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    const bgm = new Audio('bgm.mp3');
    bgm.loop = true;
    bgm.volume = 0.2;

    const ASSETS = {};
    function loadImg(name, src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => { ASSETS[name] = img; resolve(img); };
        img.onerror = () => reject(new Error(`Failed to load ${src}`));
        img.src = src;
      });
    }

    async function loadAll(){
      await Promise.all([
        loadImg('p1','bachimaru-1.png'),
        loadImg('p2','bachimaru-2.png'),
        loadImg('hive','hachinosu.png'),
        loadImg('jar','mitsutsubo.png'),
        loadImg('shot','ichigo.png'),
        loadImg('bg','tree.png'),
      ]);
    }

    const player = { x: W/2, y: H/2, w: 75, h: 75, speed: 4, shootCooldown: 0, frame: 0, animTimer: 0 };
    const keys = {};
    window.addEventListener('keydown', e => { keys[e.key] = true; });
    window.addEventListener('keyup', e => { keys[e.key] = false; });

    let shotCount = 0, canShoot = true;
    const shots = [];
    const hives = [];
    let score = 0, honey = 0, misses = 0, combo = 0, maxCombo = 0;
    let spawnTimer = 0;
    let gameRunning = false;
    let gameTime = 0; // 経過フレーム数（難易度上昇用）

    function shoot() {
      if(!gameRunning || !canShoot || player.shootCooldown > 0) return;
      shots.push({x: player.x, y: player.y - 30, vy: -7, r: 14});
      player.shootCooldown = 10;
      shotCount++;
      if(shotCount >= 5){
        canShoot = false;
        setTimeout(() => { shotCount = 0; canShoot = true; }, 700);
      }
    }
    canvas.addEventListener('mousedown', e => { if(e.button === 0) shoot(); });

    function spawnHive(){
      const x = 40 + Math.random() * (W - 80);
      const baseSpeed = 1.2 + Math.random() * 1.5;
      const speedUp = Math.min(gameTime / 600, 3); // 600フレーム(10秒)ごとに徐々に加速、最大+3
      hives.push({x: x, y: -60, vy: baseSpeed + speedUp, w: 64, h: 64, hp: 1});
    }

    function rectCircleCollide(rx, ry, rw, rh, cx, cy, cr){
      const testX = Math.max(rx, Math.min(cx, rx + rw));
      const testY = Math.max(ry, Math.min(cy, ry + rh));
      const dx = cx - testX;
      const dy = cy - testY;
      return (dx * dx + dy * dy) <= (cr * cr);
    }

    function addScore(base){
      const bonus = Math.max(0, combo - 1) * 50;
      score += base + bonus;
      honey++;
      combo++;
      maxCombo = Math.max(maxCombo, combo);
    }
    function addMiss(){
      misses++;
      combo = 0;
      if(misses >= 5) endGame();
    }

    function update(){
      if(!gameRunning) return;
      gameTime++;

      if(keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
      if(keys['ArrowRight'] || keys['d']) player.x += player.speed;
      if(keys['ArrowUp'] || keys['w']) player.y -= player.speed;
      if(keys['ArrowDown'] || keys['s']) player.y += player.speed;
      player.x = Math.max(player.w/2, Math.min(W - player.w/2, player.x));
      player.y = Math.max(player.h/2, Math.min(H - player.h/2, player.y));

      if(player.shootCooldown > 0) player.shootCooldown--;

      spawnTimer--;
      if(spawnTimer <= 0){
        spawnHive();
        spawnTimer = 60 - Math.min(40, Math.floor(score / 200));
      }

      for(let i = shots.length - 1; i >= 0; i--){
        shots[i].y += shots[i].vy;
        if(shots[i].y < -20) shots.splice(i, 1);
      }

      for(let i = hives.length - 1; i >= 0; i--){
        const h = hives[i];
        h.y += h.vy;
        if(h.y > H - 80){
          hives.splice(i, 1);
          addMiss();
          continue;
        }
        for(let j = shots.length - 1; j >= 0; j--){
          const s = shots[j];
          if(rectCircleCollide(h.x - h.w / 2, h.y - h.h / 2, h.w, h.h, s.x, s.y, s.r)){
            shots.splice(j, 1);
            if(--h.hp <= 0){
              hives.splice(i, 1);
              addScore(100);
            }
            break;
          }
        }
      }

      player.animTimer++;
      if(player.animTimer >= 10){
        player.frame = (player.frame + 1) % 2;
        player.animTimer = 0;
      }
    }
　　
　　　 function draw(){
      ctx.clearRect(0, 0, W, H);
      const bg = ASSETS['bg'];
      if(bg) ctx.drawImage(bg, W/2 - 200, H/2 - 350, 550, 800);
      const jar = ASSETS['jar'];
      if(jar) ctx.drawImage(jar, W/2 - 60, H - 130, 120, 120);
      const hiveImg = ASSETS['hive'];
      hives.forEach(h => hiveImg && ctx.drawImage(hiveImg, h.x - h.w/2, h.y - h.h/2, h.w, h.h));
      const shotImg = ASSETS['shot'];
      shots.forEach(s => shotImg && ctx.drawImage(shotImg, s.x - 16, s.y - 16, 32, 32));
      const pImg = player.frame === 0 ? ASSETS['p1'] : ASSETS['p2'];
      if(pImg) ctx.drawImage(pImg, player.x - player.w/2, player.y - player.h/2, player.w, player.h);

      ctx.fillStyle = 'black';
      ctx.font = '18px sans-serif';
      ctx.fillText(`SCORE: ${score}`, 10, 26);
      ctx.fillText(`HONEY: ${honey}`, 10, 50);
      ctx.fillText(`MISS: ${misses}/5`, 10, 74);
      ctx.fillText(`COMBO: ${combo}`, 10, 98);
    }

    function loop(){
      update();
      draw();
      if(gameRunning) requestAnimationFrame(loop);
    }

    function init(){
      spawnTimer = 60;
      score = 0; honey = 0; misses = 0; combo = 0; maxCombo = 0;
      shots.length = 0; hives.length = 0;
      player.x = W/2; player.y = H/2;
      player.shootCooldown = 0; player.frame = 0; player.animTimer = 0;
      shotCount = 0; canShoot = true;
      gameTime = 0;
      gameRunning = true;
      bgm.currentTime = 0;
      bgm.play();
      requestAnimationFrame(loop);
    }

    function endGame(){
      gameRunning = false;
      bgm.pause();
      alert(`ゲームオーバー！\nスコア: ${score}\nハチミツ: ${honey}\n最高コンボ: ${maxCombo}`);
    }

    document.getElementById('retryBtn').addEventListener('click', init);
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('startScreen').style.display = 'none';
      init();
    });

    loadAll();
  </script>
</body>
</html>
